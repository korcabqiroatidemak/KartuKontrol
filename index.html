<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cetak Kartu Kontrol Peserta (F4 - 4 Bagian)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ================================================= */
        /* 1. SETUP PAGE (F4) & CONTAINER                    */
        /* ================================================= */
        @page {
            size: 215mm 330mm; /* Ukuran F4 */
            margin: 0;         /* Margin 0 (Full Bleed) */
        }
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #525659; /* Abu-abu untuk preview layar */
            margin: 0;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Container Halaman */
        .page-container {
            background-color: white;
            width: 215mm;
            height: 330mm;
            position: relative; /* Acuan absolute positioning */
            
            /* Tampilan Layar */
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            
            /* Grid 2x2 */
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            
            box-sizing: border-box;
            page-break-after: always;
            overflow: hidden;
        }

        /* ================================================= */
        /* 2. GARIS POTONG (CUTTING LINES)                   */
        /* ================================================= */
        /* Garis Vertikal Tengah */
        .cut-line-vertical {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            border-left: 1px dashed #999;
            z-index: 10;
        }
        /* Garis Horizontal Tengah */
        .cut-line-horizontal {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            border-top: 1px dashed #999;
            z-index: 10;
        }

        /* ================================================= */
        /* 3. WRAPPER KARTU (1/4 HALAMAN)                    */
        /* ================================================= */
        .card-wrapper {
            width: 100%;
            height: 100%;
            /* Padding 0.5cm (5mm) di setiap sisi dalam */
            padding: 5mm; 
            box-sizing: border-box;
            display: flex;
        }

        /* Border Kartu (Garis Pinggir Hitam) */
        .card-border {
            border: 1px solid #000;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 5px; 
            box-sizing: border-box;
            position: relative;
        }

        /* ================================================= */
        /* 4. KONTEN KARTU                                   */
        /* ================================================= */
        
        /* HEADER */
        .header {
            display: flex;
            align-items: center;
            border-bottom: 3px double #000;
            padding-bottom: 5px;
            margin-bottom: 5px;
            height: 2.2cm;
        }
        .header-logo {
            width: 1.8cm;
            text-align: center;
        }
        .header-logo img { width: 100%; }
        
        .header-text {
            flex: 1;
            text-align: center;
            font-family: 'Times New Roman', serif;
            line-height: 1.2;
        }
        .txt-kontrol { font-size: 10pt; font-weight: bold; }
        .txt-eval { font-size: 9pt; }
        .txt-ebtaq { font-size: 10pt; font-weight: bold; }
        
        .header-nomor {
            width: 1.2cm;
            height: 1.2cm;
            border: 2px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14pt;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            margin-left: 5px;
        }

        /* INFO BAR (Gelombang, Shift) */
        .info-bar {
            display: flex;
            justify-content: space-between;
            font-size: 9pt;
            font-weight: bold;
            border-bottom: 1px solid #000;
            padding-bottom: 3px;
            margin-bottom: 5px;
        }

        /* BIODATA & FOTO */
        .biodata-container {
            display: flex;
            margin-bottom: 5px;
        }
        .biodata-text {
            flex: 1;
            font-size: 9pt;
        }
        .bio-row { display: flex; margin-bottom: 2px; }
        .bio-label { width: 2.2cm; }
        .bio-val { flex: 1; font-weight: bold; text-transform: uppercase; }
        .nama-besar {
            font-size: 11pt;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            margin: 5px 0;
            border: 1px solid #ccc;
            background: #f9f9f9;
            padding: 2px;
            -webkit-print-color-adjust: exact;
        }

        .foto-box {
            width: 2.5cm;
            height: 3.2cm;
            border: 1px solid #000;
            margin-left: 5px;
            background: #eee;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .foto-box img { width: 100%; height: 100%; object-fit: cover; }

        /* TABEL NILAI */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8pt;
            flex: 1;
        }
        th, td {
            border: 1px solid #000;
            padding: 2px 4px;
        }
        th { 
            background-color: #ddd; 
            text-align: center; 
            -webkit-print-color-adjust: exact;
        }
        .col-no { width: 20px; text-align: center; }
        .col-paraf { width: 35%; text-align: center; }

        /* PRINT SETTINGS */
        @media print {
            body { background-color: white; padding: 0; display: block; }
            .page-container { margin: 0; box-shadow: none; border: none; }
            #loading { display: none; }
        }
    </style>
</head>
<body>

    <div id="loading" style="text-align: center; margin-top: 50px; color: white;">
        <h3>Memuat Data...</h3>
    </div>
    <div id="main-output"></div>

    <script>
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Biodata Cek`; 
        const LOGO_FILENAME = "QIRAATI.png"; 

        const mainOutput = document.getElementById('main-output');
        const loading = document.getElementById('loading');

        function getDirectDriveUrl(url) {
            if (!url) return '';
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (matchId && matchId[1]) return `https://lh3.googleusercontent.com/d/${matchId[1]}`;
            return url;
        }

        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("Gagal ambil data");
                const csvText = await response.text();
                loading.style.display = 'none';
                processCSV(csvText);
            } catch (error) {
                loading.innerText = 'Error: ' + error.message;
            }
        }

        function processCSV(csvText) {
            const rows = csvText.trim().split('\n').filter(r => r.trim().length > 0);
            if (rows.length < 2) return;

            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const allParticipants = [];

            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                let p = { 'NO': i + 1 };
                rowData.forEach((val, idx) => {
                    p[headers[idx]] = val ? val.trim().replace(/"/g, '') : '';
                });
                allParticipants.push(p);
            }

            // GRID 2x2 = 4 Kartu per halaman
            const ITEMS_PER_PAGE = 4; 
            let currentPageDiv = createNewPage();
            let countInPage = 0;

            allParticipants.forEach((data, index) => {
                if (countInPage === ITEMS_PER_PAGE) {
                    mainOutput.appendChild(currentPageDiv);
                    currentPageDiv = createNewPage();
                    countInPage = 0;
                }
                
                const cardElement = createCardHTML(data, index);
                currentPageDiv.appendChild(cardElement);
                countInPage++;
            });

            // Isi sisa grid kosong agar garis potong tetap benar (opsional tapi rapi)
            if (currentPageDiv.hasChildNodes()) {
                while(countInPage < ITEMS_PER_PAGE) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'card-wrapper'; // Placeholder kosong
                    currentPageDiv.appendChild(emptyDiv);
                    countInPage++;
                }
                mainOutput.appendChild(currentPageDiv);
            }
        }

        function createNewPage() {
            const div = document.createElement('div');
            div.className = 'page-container';
            // Tambahkan garis potong otomatis
            div.innerHTML = `
                <div class="cut-line-vertical"></div>
                <div class="cut-line-horizontal"></div>
            `;
            return div;
        }

        function createCardHTML(data, index) {
            const wrapper = document.createElement('div');
            wrapper.className = 'card-wrapper';

            // Mapping Data
            const NAMA = data['Nama Lengkap (Sesuai Akta)'] || '';
            const ID_PESERTA = data['ID Pendaftaran'] || '-';
            const LEMBAGA = data['Asal Lembaga / TPQ'] || '-';
            
            // Header Baru
            const NOMOR = data['Nomor'] || data['NO'] || '..';
            const GELOMBANG = data['Gelombang'] || '-';
            const SHIFT = data['Shift'] || '-';

            const rawFoto = data['Kirim Pas Foto Ukuran PostCard'] || '';
            const FOTO_URL = getDirectDriveUrl(rawFoto);

            wrapper.innerHTML = `
                <div class="card-border">
                    <div class="header">
                        <div class="header-logo">
                            <img src="${LOGO_FILENAME}" onerror="this.style.display='none'">
                        </div>
                        <div class="header-text">
                            <div class="txt-kontrol">KARTU KONTROL PESERTA</div>
                            <div class="txt-eval">EVALUASI BELAJAR</div>
                            <div class="txt-ebtaq">TAHAP AKHIR QIROATI (EBTAQ)</div>
                        </div>
                        <div class="header-nomor">${NOMOR}</div>
                    </div>

                    <div class="info-bar">
                        <span>Gel: ${GELOMBANG}</span>
                        <span>Shift: ${SHIFT}</span>
                        <span style="font-size:8pt">${ID_PESERTA}</span>
                    </div>

                    <div class="biodata-container">
                        <div class="biodata-text">
                            <div class="nama-besar">${NAMA}</div>
                            <div class="bio-row">
                                <div class="bio-label">Lembaga</div>
                                <div class="bio-val">: ${LEMBAGA}</div>
                            </div>
                        </div>
                        <div class="foto-box">
                            <img src="${FOTO_URL}" onerror="this.style.display='none'">
                        </div>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th class="col-no">NO</th>
                                <th>MATERI</th>
                                <th class="col-paraf">PARAF PENGUJI</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="col-no">1</td>
                                <td>FASHOHAH</td>
                                <td>1.</td>
                            </tr>
                            <tr>
                                <td class="col-no">2</td>
                                <td>TARTIL</td>
                                <td style="text-align:right">2.</td>
                            </tr>
                            <tr>
                                <td class="col-no">3</td>
                                <td>GHARIB</td>
                                <td>3.</td>
                            </tr>
                            <tr>
                                <td class="col-no">4</td>
                                <td>TAJWID</td>
                                <td style="text-align:right">4.</td>
                            </tr>
                            <tr>
                                <td class="col-no">5</td>
                                <td>DDH</td>
                                <td>5.</td>
                            </tr>
                            <tr>
                                <td class="col-no">6</td>
                                <td>SSP</td>
                                <td style="text-align:right">6.</td>
                            </tr>
                            <tr>
                                <td class="col-no">7</td>
                                <td>SHOLAT</td>
                                <td>7.</td>
                            </tr>
                            <tr>
                                <td class="col-no">8</td>
                                <td>WUDHU</td>
                                <td style="text-align:right">8.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            return wrapper;
        }

        fetchSheetData();
    </script>
</body>
</html>
