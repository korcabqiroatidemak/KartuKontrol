<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kartu Kontrol EBTAQ - Final Precision</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ================================================= */
        /* 1. DASAR HALAMAN F4                               */
        /* ================================================= */
        @page { size: 215mm 330mm; margin: 0; }
        body {
            font-family: Arial, sans-serif;
            background-color: #525659;
            margin: 0; padding: 20px 0;
            display: flex; flex-direction: column; align-items: center;
        }

        .page-container {
            background-color: white;
            width: 215mm; height: 330mm;
            position: relative;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            box-sizing: border-box;
            page-break-after: always;
            overflow: hidden;
        }

        .cut-line-v { position: absolute; left: 50%; top: 0; bottom: 0; border-left: 1px dashed #999; z-index: 10; }
        .cut-line-h { position: absolute; top: 50%; left: 0; right: 0; border-top: 1px dashed #999; z-index: 10; }

        /* ================================================= */
        /* 2. AREA KARTU                                     */
        /* ================================================= */
        .card-wrapper { padding: 5mm; box-sizing: border-box; display: flex; }

        .card-frame {
            border: 2px solid #000080;
            width: 100%; height: 100%;
            padding: 5px; box-sizing: border-box;
            display: flex; flex-direction: column;
            position: relative;
        }

        /* Header */
        .header {
            display: flex; align-items: center;
            border-bottom: 2px solid #000;
            padding-bottom: 4px; margin-bottom: 8px;
        }
        .logo { width: 45px; height: 45px; }
        .logo img { width: 100%; height: 100%; object-fit: contain; }
        .title-group { flex: 1; text-align: center; font-family: "Times New Roman", serif; line-height: 1.1; }
        .nomor-box {
            width: 40px; height: 30px; background-color: #FFC000;
            border: 2px solid #000; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14pt; font-family: 'Courier New', monospace;
            -webkit-print-color-adjust: exact;
        }

        /* ================================================= */
        /* 3. GRID IDENTITAS (NARRATIVE STYLE)               */
        /* ================================================= */
        .identity-grid {
            display: grid;
            grid-template-columns: 2.8cm auto 2.6cm; 
            grid-template-rows: repeat(5, 0.65cm); 
            width: 100%;
            margin-bottom: 10px;
        }

        .id-photo {
            grid-column: 1; grid-row: 1 / span 5;
            background: #eee; border: 1px solid #ccc;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        .id-photo img { width: 100%; height: 100%; object-fit: cover; }

        .id-text-row {
            grid-column: 2;
            padding-left: 10px; 
            font-size: 11pt; 
            font-weight: bold; 
            display: flex; align-items: center;
            border-bottom: 1px dotted #ccc;
        }

        .id-qr {
            grid-column: 3; grid-row: 1 / span 3;
            display: flex; justify-content: flex-end; align-items: flex-start;
            border-bottom: 1px dotted #ccc;
        }

        .id-lembaga-full {
            grid-column: 2 / span 2; 
            padding-left: 10px; 
            font-size: 10.5pt;
            display: flex; align-items: center;
            border-bottom: 1px dotted #ccc;
            white-space: nowrap;
        }

        /* Nama Peserta */
        .nama-box {
            height: 1.6cm; width: 100%;
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-weight: bold; font-size: 12pt;
            text-transform: uppercase; line-height: 1.1;
            margin-bottom: 5px;
            background-color: #f2f2f2;
            -webkit-print-color-adjust: exact;
        }

        /* Tabel Penilaian */
        table { width: 100%; border-collapse: collapse; border: 2px solid #000; flex: 1; }
        th, td { border: 1px solid #000; padding: 2px 4px; font-size: 9pt; }
        th { background-color: #ccc; font-weight: bold; text-align: center; -webkit-print-color-adjust: exact; }
        .col-no { width: 25px; text-align: center; }
        .col-materi { font-weight: bold; }

        @media print {
            body { background: white; padding: 0; }
            .page-container { margin: 0; box-shadow: none; border: none; }
            #loading { display: none; }
            .id-text-row, .id-lembaga-full, .id-qr { border-bottom: 1px dotted #ccc !important; }
        }
    </style>
</head>
<body>

    <div id="loading" style="text-align: center; margin-top: 50px; color: white;">
        <h3>Menyusun Kartu EBTAQ...</h3>
    </div>
    <div id="main-output"></div>

    <script>
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        const SHEET_NAME = 'Biodata Cek';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
        const LOGO_FILENAME = "QIRAATI.png";

        function getDirectDriveUrl(url) {
            if (!url) return '';
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            return matchId ? `https://lh3.googleusercontent.com/d/${matchId[1]}` : url;
        }

        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                processCSV(csvText);
            } catch (error) {
                document.getElementById('loading').innerText = "Gagal memuat data.";
            }
        }

        function processCSV(csvText) {
            const rows = csvText.trim().split('\n').filter(r => r.trim().length > 0);
            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                let p = {};
                rowData.forEach((val, idx) => { p[headers[idx]] = val ? val.trim().replace(/"/g, '') : ''; });
                data.push(p);
            }
            document.getElementById('loading').style.display = 'none';
            renderCards(data);
        }

        function renderCards(participants) {
            const perPage = 4;
            let currentContainer = createPage();
            participants.forEach((p, i) => {
                if (i > 0 && i % perPage === 0) {
                    document.getElementById('main-output').appendChild(currentContainer);
                    currentContainer = createPage();
                }
                currentContainer.appendChild(createCard(p, i));
                generateQR(p['ID Pendaftaran'], `qr-${i}`);
            });
            document.getElementById('main-output').appendChild(currentContainer);
        }

        function createPage() {
            const div = document.createElement('div');
            div.className = 'page-container';
            div.innerHTML = '<div class="cut-line-v"></div><div class="cut-line-h"></div>';
            return div;
        }

        function createCard(p, i) {
            const wrap = document.createElement('div');
            wrap.className = 'card-wrapper';
            
            // --- TRANSFORMASI DATA ---
            
            // 1. Gelombang: Tetap Angka Biasa
            const gelombangText = `Gelombang ${p['Gelombang'] || '-'}`;

            // 2. Shift: Konversi ke Romawi + Jam
            const sVal = String(p['Shift']).trim();
            let shiftDisplay = `Shift ${sVal}`; 
            if (sVal === "1") shiftDisplay = "Shift I (07.00 WIB)";
            else if (sVal === "2") shiftDisplay = "Shift II (08.30 WIB)";
            else if (sVal === "3") shiftDisplay = "Shift III (10.00 WIB)";

            // 3. Lembaga: Split & Batas 50 karakter
            const rawL = p['Asal Lembaga / TPQ'] || '-';
            let kota = "", sekolah = rawL;
            if (rawL.includes("-")) {
                const pts = rawL.split("-");
                kota = pts[0].trim();
                sekolah = pts.slice(1).join("-").trim();
            }
            if (sekolah.length > 50) { sekolah = sekolah.substring(0, 46) + " ..."; }

            const noPad = String(p['NOMOR'] || p['Nomor'] || (i + 1)).padStart(3, '0');

            wrap.innerHTML = `
                <div class="card-frame">
                    <div class="header">
                        <div class="logo"><img src="${LOGO_FILENAME}" onerror="this.style.visibility='hidden'"></div>
                        <div class="title-group">
                            <div class="t1">KARTU KONTROL PESERTA</div>
                            <div class="t2">EVALUASI BELAJAR</div>
                            <div class="t3">TAHAP AKHIR QIROATI (EBTAQ)</div>
                        </div>
                        <div class="nomor-box">${noPad}</div>
                    </div>

                    <div class="identity-grid">
                        <div class="id-photo"><img src="${getDirectDriveUrl(p['Kirim Pas Foto Ukuran PostCard'])}" onerror="this.style.display='none'"></div>
                        
                        <div class="id-text-row">${p['ID Pendaftaran'] || '-'}</div>
                        
                        <div class="id-text-row">${gelombangText}</div>
                        
                        <div class="id-text-row">${shiftDisplay}</div>
                        
                        <div class="id-qr"><div id="qr-${i}"></div></div>

                        <div class="id-lembaga-full" style="color: #666; font-size: 9pt;">${kota}</div>
                        <div class="id-lembaga-full" style="font-weight:bold;">${sekolah}</div>
                    </div>

                    <div class="nama-box">${(p['Nama Lengkap (Sesuai Akta)'] || '').toUpperCase()}</div>

                    <table>
                        <thead><tr><th class="col-no">NO</th><th>MATERI</th><th colspan="2">PARAF PENGUJI</th></tr></thead>
                        <tbody>
                            ${["FASHOHAH","TARTIL","GHARIB","TAJWID","DDH","SSP","SHOLAT","WUDHU"].map((m, idx) => `
                                <tr>
                                    <td class="col-no">${idx+1}</td>
                                    <td class="col-materi">${m}</td>
                                    <td style="width:17.5%; border-right:1px solid #000; vertical-align:top; font-size:7pt; color:#ccc;">${(idx%2===0)?(idx+1):''}</td>
                                    <td style="width:17.5%; vertical-align:top; font-size:7pt; color:#ccc;">${(idx%2!==0)?(idx+1):''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            return wrap;
        }

        function generateQR(txt, id) {
            setTimeout(() => {
                const el = document.getElementById(id);
                if (el) new QRCode(el, { text: txt || "N/A", width: 75, height: 75 });
            }, 100);
        }

        fetchSheetData();
    </script>
</body>
</html>
