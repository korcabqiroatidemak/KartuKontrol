<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kartu Kontrol Peserta (Text Truncate Fix)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ================================================= */
        /* 1. SETUP HALAMAN (F4)                             */
        /* ================================================= */
        @page {
            size: 215mm 330mm;
            margin: 0;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #525659;
            margin: 0;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-container {
            background-color: white;
            width: 215mm;
            height: 330mm;
            position: relative;
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            box-sizing: border-box;
            page-break-after: always;
            overflow: hidden;
        }

        /* Garis Potong */
        .cut-line-v { position: absolute; left: 50%; top: 0; bottom: 0; border-left: 1px dashed #999; z-index: 10; }
        .cut-line-h { position: absolute; top: 50%; left: 0; right: 0; border-top: 1px dashed #999; z-index: 10; }

        /* ================================================= */
        /* 2. AREA KARTU (1/4 HALAMAN)                       */
        /* ================================================= */
        .card-wrapper {
            padding: 5mm; 
            box-sizing: border-box;
            display: flex;
        }

        .card-frame {
            border: 2px solid #000080; /* Navy Blue */
            width: 100%;
            height: 100%;
            padding: 5px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        /* Hiasan Sudut */
        .corner-tl { position: absolute; top: 2px; left: 2px; width: 10px; height: 10px; border-top: 1px solid #999; border-left: 1px solid #999; }
        .corner-tr { position: absolute; top: 2px; right: 2px; width: 10px; height: 10px; border-top: 1px solid #999; border-right: 1px solid #999; }
        .corner-bl { position: absolute; bottom: 2px; left: 2px; width: 10px; height: 10px; border-bottom: 1px solid #999; border-left: 1px solid #999; }
        .corner-br { position: absolute; bottom: 2px; right: 2px; width: 10px; height: 10px; border-bottom: 1px solid #999; border-right: 1px solid #999; }

        /* ================================================= */
        /* 3. KOMPONEN KARTU                                 */
        /* ================================================= */
        
        /* HEADER */
        .header {
            display: flex;
            align-items: center;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .logo { width: 45px; height: 45px; }
        .logo img { width: 100%; height: 100%; object-fit: contain; }
        
        .title-group {
            flex: 1;
            text-align: center;
            font-family: "Times New Roman", serif;
            color: #000;
            line-height: 1.2;
        }
        .t1 { font-size: 10pt; font-weight: bold; }
        .t2 { font-size: 9pt; font-weight: bold; }
        .t3 { font-size: 9pt; font-weight: bold; }

        .nomor-box {
            width: 40px;
            height: 30px;
            background-color: #FFC000;
            border: 2px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14pt; 
            font-family: 'Courier New', monospace;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* --- LAYOUT DIKEMBALIKAN KE ASAL (FOTO - INFO - QR) --- */
        .top-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            height: 3.8cm; /* Tinggi fix area identitas */
        }
        
        /* Area Foto */
        .photo-area {
            width: 2.8cm;
            height: 100%;
            background: #eee;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
        }
        .photo-area img { width: 100%; height: 100%; object-fit: cover; }

        /* Area Info Tengah */
        .info-area {
            flex: 1;
            padding-left: 8px;
            padding-right: 5px;
            font-size: 9pt;
            line-height: 1.3;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Center Vertikal */
        }
        
        /* Area QR Kanan */
        .qr-area {
            width: 2.6cm;
            display: flex;
            justify-content: flex-end; /* Rata Kanan */
            align-items: flex-start;   /* Mulai dari atas */
        }

        /* Styling Khusus Teks Lembaga */
        .lembaga-text {
            margin-top: 3px;
            font-weight: normal;
        }
        
        /* --- NAMA PESERTA (FIXED HEIGHT & CENTER) --- */
        .nama-peserta-box {
            height: 1.6cm; /* Ruang untuk 3 baris */
            width: 100%;
            display: flex;
            align-items: center;     /* Center Vertikal */
            justify-content: center; /* Center Horizontal */
            text-align: center;
            font-weight: bold;
            font-size: 11pt;
            text-transform: uppercase;
            line-height: 1.2;
            overflow: hidden;
            margin-bottom: 5px;
            /* border: 1px dashed #ccc; */ /* Uncomment untuk debug area nama */
        }

        /* TABEL NILAI */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt;
            border: 2px solid #000;
            flex: 1; 
        }
        th {
            border: 1px solid #000;
            background-color: #ccc;
            padding: 2px;
            font-weight: bold;
            text-align: center;
            font-size: 9pt;
            -webkit-print-color-adjust: exact;
        }
        td {
            border: 1px solid #000;
            padding: 2px 4px;
            vertical-align: middle;
            font-size: 9pt;
        }
        
        .col-no { width: 30px; text-align: center; font-weight: bold; }
        .col-materi { font-weight: bold; }

        /* PRINT SETTINGS */
        @media print {
            body { background-color: white; padding: 0; display: block; }
            .page-container { margin: 0; box-shadow: none; border: none; }
            #loading, #error-msg { display: none; }
            .nomor-box { background-color: #FFC000 !important; -webkit-print-color-adjust: exact; }
            th { background-color: #ccc !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div id="loading" style="text-align: center; margin-top: 50px; color: white;">
        <h3>Memuat Data...</h3>
    </div>
    <div id="error-msg" style="text-align: center; margin-top: 20px; color: yellow; display: none;"></div>
    <div id="main-output"></div>

    <script>
        const SHEET_ID = '1eIcvIgCLWG3F9jQdsw5XN9llOsK2PoYWKUg1qaQJyyA';
        const SHEET_NAME = 'Biodata Cek';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
        
        const LOGO_FILENAME = "QIRAATI.png"; 

        const mainOutput = document.getElementById('main-output');
        const loading = document.getElementById('loading');
        const errorMsg = document.getElementById('error-msg');

        function getDirectDriveUrl(url) {
            if (!url) return '';
            const matchId = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (matchId && matchId[1]) {
                return `https://lh3.googleusercontent.com/d/${matchId[1]}`;
            }
            return url;
        }

        async function fetchSheetData() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error("Gagal mengambil data");
                const csvText = await response.text();
                processCSV(csvText);
            } catch (error) {
                loading.style.display = 'none';
                errorMsg.style.display = 'block';
                errorMsg.innerHTML = `Error: ${error.message}`;
            }
        }

        function processCSV(csvText) {
            const rows = csvText.trim().split('\n').filter(r => r.trim().length > 0);
            if (rows.length < 2) return;

            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const allParticipants = [];

            for (let i = 1; i < rows.length; i++) {
                const rowData = rows[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                let p = {};
                rowData.forEach((val, idx) => {
                    p[headers[idx]] = val ? val.trim().replace(/"/g, '') : '';
                });
                allParticipants.push(p);
            }

            loading.style.display = 'none';
            renderCards(allParticipants);
        }

        function renderCards(allParticipants) {
            const ITEMS_PER_PAGE = 4; 
            let currentPageDiv = createNewPage();
            let countInPage = 0;

            allParticipants.forEach((data, index) => {
                if (countInPage === ITEMS_PER_PAGE) {
                    mainOutput.appendChild(currentPageDiv);
                    currentPageDiv = createNewPage();
                    countInPage = 0;
                }
                
                const cardElement = createCardHTML(data, index);
                currentPageDiv.appendChild(cardElement);
                countInPage++;

                setTimeout(() => {
                    const el = document.getElementById(`qr-${index}`);
                    if(el) {
                        el.innerHTML = "";
                        new QRCode(el, {
                            text: data['ID Pendaftaran'] || 'NODATA',
                            width: 80, height: 80,
                            correctLevel: QRCode.CorrectLevel.L
                        });
                    }
                }, 100);
            });

            if (currentPageDiv.hasChildNodes()) {
                mainOutput.appendChild(currentPageDiv);
            }
        }

        function createNewPage() {
            const div = document.createElement('div');
            div.className = 'page-container';
            div.innerHTML = `<div class="cut-line-v"></div><div class="cut-line-h"></div>`;
            return div;
        }

        function createCardHTML(data, index) {
            const wrapper = document.createElement('div');
            wrapper.className = 'card-wrapper';

            // DATA DASAR
            const rawNomor = data['NOMOR'] || data['Nomor'] || '';
            const NOMOR = rawNomor ? String(rawNomor).padStart(3, '0') : '';
            const GEL = data['Gelombang'] || '-';
            const SHIFT = data['Shift'] || '-';
            const ID_EBTAQ = data['ID Pendaftaran'] || '-';
            const NAMA = (data['Nama Lengkap (Sesuai Akta)'] || '').toUpperCase();
            
            const rawFoto = data['Kirim Pas Foto Ukuran PostCard'] || '';
            const FOTO = getDirectDriveUrl(rawFoto);

            // LOGIKA PEMOTONGAN TEKS LEMBAGA
            let rawLembaga = data['Asal Lembaga / TPQ'] || '-';
            let kota = "";
            let sekolah = rawLembaga;

            // 1. Cek tanda pisah " - " (Spasi Strip Spasi) atau "-"
            if (rawLembaga.includes(" - ")) {
                const parts = rawLembaga.split(" - ");
                kota = parts[0];
                sekolah = parts[1] || ""; // Ambil sisanya
            } else if (rawLembaga.includes("-")) {
                const parts = rawLembaga.split("-");
                kota = parts[0];
                sekolah = parts.slice(1).join("-"); // Gabung sisanya jika ada strip lain
            } else {
                // Jika tidak ada strip sama sekali, anggap 'kota' kosong, 'sekolah' full text
                // Atau bisa juga sekolah = rawLembaga, kota = ""
            }

            // 2. Batasi karakter Sekolah maks 20 char -> jika lebih potong jadi 16 + ...
            if (sekolah.length > 20) {
                sekolah = sekolah.substring(0, 16) + " ...";
            }

            // Gabung HTML Lembaga
            let lembagaHTML = "";
            if (kota) {
                lembagaHTML += `<div>${kota}</div>`;
            }
            lembagaHTML += `<div>${sekolah}</div>`;


            wrapper.innerHTML = `
                <div class="card-frame">
                    <div class="corner-tl"></div><div class="corner-tr"></div>
                    <div class="corner-bl"></div><div class="corner-br"></div>

                    <div class="header">
                        <div class="logo">
                            <img src="${LOGO_FILENAME}" onerror="this.style.display='none'">
                        </div>
                        <div class="title-group">
                            <div class="t1">KARTU KONTROL PESERTA</div>
                            <div class="t2">EVALUASI BELAJAR</div>
                            <div class="t3">TAHAP AKHIR QIROATI (EBTAQ)</div>
                        </div>
                        <div class="nomor-box">${NOMOR}</div>
                    </div>

                    <div class="top-section">
                        <div class="photo-area">
                            <img src="${FOTO}" onerror="this.style.display='none'; this.parentElement.style.background='#ccc';">
                        </div>

                        <div class="info-area">
                            <div style="font-weight:bold;">ID. ${ID_EBTAQ}</div>
                            <div>Gel._: ${GEL}</div>
                            <div>Shift: ${SHIFT}</div>
                            
                            <div class="lembaga-text">
                                ${lembagaHTML}
                            </div>
                        </div>

                        <div class="qr-area">
                            <div id="qr-${index}"></div>
                        </div>
                    </div>

                    <div class="nama-peserta-box">
                        ${NAMA}
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th class="col-no">NO</th>
                                <th>MATERI</th>
                                <th colspan="2">PARAF PENGUJI</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="col-no">1</td>
                                <td class="col-materi">FASHOHAH</td>
                                <td style="width:17.5%; border-right:1px solid #000; vertical-align:top;">1</td>
                                <td style="width:17.5%;"></td>
                            </tr>
                            <tr>
                                <td class="col-no">2</td>
                                <td class="col-materi">TARTIL</td>
                                <td style="border-right:1px solid #000;"></td>
                                <td style="vertical-align:top;">2</td>
                            </tr>
                            <tr>
                                <td class="col-no">3</td>
                                <td class="col-materi">GHARIB</td>
                                <td style="border-right:1px solid #000; vertical-align:top;">3</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td class="col-no">4</td>
                                <td class="col-materi">TAJWID</td>
                                <td style="border-right:1px solid #000;"></td>
                                <td style="vertical-align:top;">4</td>
                            </tr>
                            <tr>
                                <td class="col-no">5</td>
                                <td class="col-materi">DDH</td>
                                <td style="border-right:1px solid #000; vertical-align:top;">5</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td class="col-no">6</td>
                                <td class="col-materi">SSP</td>
                                <td style="border-right:1px solid #000;"></td>
                                <td style="vertical-align:top;">6</td>
                            </tr>
                            <tr>
                                <td class="col-no">7</td>
                                <td class="col-materi">SHOLAT</td>
                                <td style="border-right:1px solid #000; vertical-align:top;">7</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td class="col-no">8</td>
                                <td class="col-materi">WUDHU</td>
                                <td style="border-right:1px solid #000;"></td>
                                <td style="vertical-align:top;">8</td>
                            </tr>
                        </tbody>
                    </table>

                </div>
            `;
            return wrapper;
        }

        fetchSheetData();
    </script>
</body>
</html>
